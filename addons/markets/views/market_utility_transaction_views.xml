<odoo>
    <!-- Market Utility Transaction Tree View -->
    <record id="view_market_utility_transaction_tree" model="ir.ui.view">
        <field name="name">kst.market.utility.transaction.tree</field>
        <field name="model">kst.market.utility.transaction</field>
        <field name="arch" type="xml">
            <tree string="Utility Collections">
                <field name="transaction_date"/>
                <field name="billing_type"/>
                <field name="stall_id"/>
                <field name="utility_bill_id"/>
                <field name="market_id"/>
                <field name="tenant_id"/>
                <field name="utility_type"/>
                <field name="verification_status" widget="badge" decoration-success="verification_status == 'verified'" decoration-warning="verification_status == 'check_bounced'" decoration-danger="verification_status == 'rejected'"/>
                <field name="is_absent"/>
                <field name="previous_reading"/>
                <field name="current_reading"/>
                <field name="consumption" sum="Total Consumption"/>
                <field name="applied_rate"/>
                <field name="amount_due" sum="Total Due"/>
                <field name="amount_paid" sum="Total Amount"/>
                <field name="receipt_number"/>
                <field name="attachment_count" string="ðŸ“Ž"/>
                <field name="create_uid" string="Encoded By"/>
            </tree>
        </field>
    </record>

    <!-- Market Utility Transaction Form View -->
    <record id="view_market_utility_transaction_form" model="ir.ui.view">
        <field name="name">kst.market.utility.transaction.form</field>
        <field name="model">kst.market.utility.transaction</field>
        <field name="arch" type="xml">
            <form string="Utility Collection">
                <header>
                    <button name="action_verify"
                            type="object"
                            string="Verify"
                            class="oe_highlight"
                            attrs="{'invisible': [('verification_status', '!=', 'pending')]}"
                            help="Mark transaction as verified by manager"/>
                    <button name="action_check_bounced"
                            type="object"
                            string="Check Bounced"
                            attrs="{'invisible': [('verification_status', '!=', 'pending')]}"
                            help="Mark transaction as check bounced"/>
                    <button name="action_reject"
                            type="object"
                            string="Reject"
                            attrs="{'invisible': [('verification_status', '!=', 'pending')]}"
                            help="Reject the transaction"/>
                    <button name="action_generate_soa"
                            type="object"
                            string="Generate SOA"
                            class="btn-secondary"
                            attrs="{'invisible': [('soa_issuable', '=', False)]}"
                            help="Generate a Statement of Account for this underpaid transaction (prototype)"/>
                    <field name="verification_status" widget="statusbar" statusbar_visible="pending,verified"/>
                </header>
                <sheet>
                    <group>
                        <group string="Billing Information">
                            <field name="billing_type" readonly="1"/>
                            <field name="stall_id" required="1"/>
                            <field name="utility_bill_id"/>
                            <field name="market_id"/>
                            <field name="tenant_id"/>
                        </group>
                        <group string="Transaction Details">
                            <field name="transaction_date"/>
                            <field name="utility_type"/>
                            <field name="is_absent"/>
                            <field name="receipt_number"/>
                        </group>
                    </group>
                    <group>
                        <group string="Meter Readings &amp; Rate">
                            <field name="previous_reading"/>
                            <field name="current_reading"/>
                            <field name="consumption" readonly="1"/>
                            <field name="applied_rate" help="Rate used for this transaction (from bill or default rate)"/>
                            <field name="is_absent" help="Mark as absent to exclude from flat rate billing"/>
                        </group>
                        <group string="Financial Information">
                            <field name="amount_due" readonly="1"/>
                            <field name="amount_paid"/>
                        </group>
                    </group>
                    <!-- Hidden helper for header attrs -->
                    <field name="soa_issuable" invisible="1"/>
                    <notebook>
                        <page string="Attachments" name="attachments">
                            <field name="attachment_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="name"/>
                                    <field name="payment_method"/>
                                    <field name="attachment_file" filename="attachment_filename" widget="binary"/>
                                    <field name="attachment_filename" invisible="1"/>
                                    <field name="notes"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                    <group>
                        <group string="Audit Trail">
                            <field name="create_uid" string="Encoded By" readonly="1"/>
                            <field name="create_date" string="Encoded Date" readonly="1"/>
                            <field name="write_uid" string="Modified By" readonly="1"/>
                            <field name="write_date" string="Modified Date" readonly="1"/>
                        </group>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Market Utility Transaction Search View -->
    <record id="view_market_utility_transaction_search" model="ir.ui.view">
        <field name="name">kst.market.utility.transaction.search</field>
        <field name="model">kst.market.utility.transaction</field>
        <field name="arch" type="xml">
            <search string="Utility Collections">
                <field name="stall_id"/>
                <field name="utility_bill_id"/>
                <field name="market_id"/>
                <field name="tenant_id"/>
                <field name="receipt_number"/>
                <filter name="electricity" string="Electricity" domain="[('utility_type', '=', 'electricity')]"/>
                <filter name="water" string="Water" domain="[('utility_type', '=', 'water')]"/>
                <filter name="metered" string="Metered (From Bill)" domain="[('utility_bill_id', '!=', False)]"/>
                <filter name="flat_rate" string="Flat Rate" domain="[('utility_bill_id', '=', False)]"/>
                <separator/>
                <filter name="verification_pending" string="Pending Review" domain="[('verification_status', '=', 'pending')]"/>
                <filter name="verification_verified" string="Verified" domain="[('verification_status', '=', 'verified')]"/>
                <filter name="verification_bounced" string="Check Bounced" domain="[('verification_status', '=', 'check_bounced')]"/>
                <filter name="verification_rejected" string="Rejected" domain="[('verification_status', '=', 'rejected')]"/>
                <filter name="absent" string="Absent" domain="[('is_absent', '=', True)]"/>
                <group expand="0">
                    <filter name="group_by_utility" string="Utility Type" context="{'group_by':'utility_type'}"/>
                    <filter name="group_by_market" string="Market" context="{'group_by':'market_id'}"/>
                    <filter name="group_by_tenant" string="Tenant" context="{'group_by':'tenant_id'}"/>
                    <filter name="group_by_verification" string="Verification Status" context="{'group_by':'verification_status'}"/>
                    <filter name="group_by_date" string="Transaction Date" context="{'group_by':'transaction_date'}"/>
                    <filter name="group_by_bill" string="Utility Bill" context="{'group_by':'utility_bill_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Market Utility Transaction Action -->
    <record id="action_market_utility_transaction" model="ir.actions.act_window">
        <field name="name">Utility Collections</field>
        <field name="res_model">kst.market.utility.transaction</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!-- Menu Structure -->
    <!-- Root Menu -->
    <menuitem id="menu_markets_root" 
              name="Markets" 
              sequence="10"/>

    <!-- Transactions Menu (Managers only - cashiers work through billing views) -->
    <menuitem id="menu_markets_transactions" 
              name="Transactions" 
              parent="menu_markets_root"
              groups="markets.markets_group_manager"
              sequence="10"/>
    
    <menuitem id="menu_market_rent_transaction" 
              name="Rent Collections" 
              parent="menu_markets_transactions"
              action="action_market_rent_transaction"
              groups="markets.markets_group_manager"
              sequence="10"/>
    
    <menuitem id="menu_market_utility_transaction" 
              name="Utility Collections" 
              parent="menu_markets_transactions"
              action="action_market_utility_transaction"
              groups="markets.markets_group_manager"
              sequence="20"/>

    <!-- Masterfiles Menu -->
    <menuitem id="menu_markets_masterfiles" 
              name="Masterfiles" 
              parent="menu_markets_root"
              sequence="20"/>
    
    <menuitem id="menu_market" 
              name="Markets" 
              parent="menu_markets_masterfiles"
              action="action_market"
              sequence="10"/>
    
    <menuitem id="menu_stall" 
              name="Stalls" 
              parent="menu_markets_masterfiles"
              action="action_stall"
              sequence="20"/>
    
    <menuitem id="menu_tenant" 
              name="Tenants" 
              parent="menu_markets_masterfiles"
              action="action_tenant"
              sequence="30"/>

    <!-- Configuration Menu -->
    <menuitem id="menu_markets_configuration" 
              name="Configuration" 
              parent="menu_markets_root"
              groups="markets_group_manager"
              sequence="30"/>
    
    <menuitem id="menu_market_pay_type" 
              name="Pay Types" 
              parent="menu_markets_configuration"
              action="action_market_pay_type"
              sequence="10"/>
    
    <!-- Utility Accounts Action (references model from base) -->
    <record id="action_utility_account_markets" model="ir.actions.act_window">
        <field name="name">Utility Accounts</field>
        <field name="res_model">kst.utility.account</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Utility Account!
            </p>
            <p>
                Utility accounts group stalls under a single billing account from providers like MERALCO or Water companies.
            </p>
        </field>
    </record>
    
    <menuitem id="menu_utility_account_markets" 
              name="Utility Accounts" 
              parent="menu_markets_masterfiles"
              action="action_utility_account_markets"
              sequence="40"/>
</odoo>

